pipeline {
    agent any

    stages {
        stage('Test') {
            steps {
                script {
                    deployToAppService('test')
                }
            }
        }

        stage('Stage') {
            steps {
                script {
                    deployToAppService('stage')
                }
            }
        }

        stage('Prod') {
            steps {
                script {
                    deployToAppService('prod')
                }
            }
        }
    }
}

def deployToAppService(env) {
    def appName = "<your-app-name>"
    def resourceGroup = "<your-resource-group>"
    def servicePlan = "<your-service-plan>"
    def appServiceName = appName + "-" + env

    withCredentials([azureServicePrincipal("<your-azure-credentials-ID>")]) {
        sh "az login --service-principal --username \$AZURE_CLIENT_ID --password \$AZURE_CLIENT_SECRET --tenant \$AZURE_TENANT_ID"
        sh "git clone https://github.com/<your-github-username>/<your-github-repo>.git"
        sh "az webapp deployment source config-zip --resource-group $resourceGroup --name $appServiceName --src <your-github-repo>/.zip"
        sh "az webapp restart --resource-group $resourceGroup --name $appServiceName"
    }
}
